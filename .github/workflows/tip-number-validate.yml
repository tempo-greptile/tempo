name: TIP Number Validation

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'tips/tip-[0-9]*.md'

jobs:
  validate-tip-number:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Validate TIP number is unique
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_PR=${{ github.event.pull_request.number }}
          
          # Find numbered TIP files added in this PR
          TIPS=$(git diff --name-only origin/main...HEAD | grep -E '^tips/tip-[0-9]+\.md$' || true)
          
          if [[ -z "$TIPS" ]]; then
            echo "No new numbered TIPs found"
            exit 0
          fi
          
          for TIP_FILE in $TIPS; do
            TIP_NUM=$(echo "$TIP_FILE" | sed 's/tips\/tip-\([0-9]*\)\.md/\1/')
            echo "Checking TIP-$TIP_NUM..."
            
            # Check if exists on main
            if git ls-tree origin/main "$TIP_FILE" &>/dev/null; then
              echo "::error::TIP-$TIP_NUM already exists on main"
              gh pr comment $CURRENT_PR --body "TIP-$TIP_NUM already exists on main. Choose a different number or use draft-*.md for automatic assignment."
              exit 1
            fi
            
            # Check if exists in another open PR
            CONFLICT_PR=$(gh pr list --state open --json number,files \
              --jq ".[] | select(.number != $CURRENT_PR) | select(.files[].path == \"$TIP_FILE\") | .number" \
              | head -1 || true)
            
            if [[ -n "$CONFLICT_PR" ]]; then
              echo "::error::TIP-$TIP_NUM is already used in PR #$CONFLICT_PR"
              gh pr comment $CURRENT_PR --body "TIP-$TIP_NUM is already used in PR #$CONFLICT_PR. Choose a different number or use draft-*.md for automatic assignment."
              exit 1
            fi
            
            echo "TIP-$TIP_NUM is available"
          done
